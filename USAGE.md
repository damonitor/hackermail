This document describes the detailed usage of `hkml`.  This doesn't cover all
details of `hkml` but only major features.  This document may not complete and
up to date sometimes.  Please don't hesitate at asking questions or help for
this document via GitHub issues.

As of now, this document is work in progress, so incomplete.

Commands
========

Hackermail can be executed using `hkml` command.  Using sub-command of it,
users can manipulate mails.  Users can show the list of sub-commands via the
`--help` option of `hkml`.  Similarly, each subcommand support `--help` option.

Initialization
==============

To properly work, hackermail requires 1) working directory, and 2) mailing
lists manifest.

Working Directory
-----------------

Working directory is a directory to save the fetched mails and hanckermail's
metadata.  You may think this as something similar to `.git` directory of git.

You can explicitly set the path to the directory using `HKML_DIR` environment
variable, or `--hkml_dir` option of each sub-command.  If the path is not
specified, hackermail assumes the directory is named as `.hkm` and placed under
current directory, the `hkml` executable file placed directory, or your home
directory and try to find it.  If it cannot find a proper working directory,
most of `hkml` sub-command will fail.

Manifest File
-------------

Manifest file is a file for information on mailing lists that you want to
communicate with using `hkml`.  It describes from where in the internet the
mails you want to read can be fetched, name of the mailing lists archived in
the site, and the site-relative path to the git repositories for each mailing
list in json format.  It's very similar to that of lore[1] except the fact that
hackermail manifest is containing the site information.  A sample manifest file
for the linux kernel mailing lists is located at `manifests/lore.js`, which has
generated by `update_lore_manifest.sh`.

You can explicitly set the path to the manifest file using `--manifest` option
of each sub-command.  If it is not specified, hackermail assumes it is placed
under the working directory in name of `manifest` and try to use it.

[1] https://www.kernel.org/lore.html

`init` sub-command
------------------

`init` sub-command of `hkml` does setting the working directory and manifest
file.  For example, if you call below command on this directory, it will create
the working directory as `.hkm` directory under the repo, and Linux kernel
mailing list as the manifest.  Hence, you will be able to use `hkml` for Linux
kernel mails from anywhere by using `hkml` file in this directory.

```
$ hkml init --manifest ./manifests/lore.json
```

Fetching Mails
==============

Users can download mails from specific mailing list that described on the
manifest file onto the local storage using `fetch` sub-command.  It receives
the names of the mailing lists to fetch.  By default, it receives latest
epoch's mails of given mailing lists.  For example, below command downloads
recent mails from linux-mm mailing list.

```
$ hkml fetch linux-mm
```

Note that fetching can be done with `list` sub-command, which will be described
below.  In some use cases, `fetch` sub-command may not frequently used.

Listing Mails
=============

Users can list mails of specific mailing list on the manifest file via `list`
sub-command.  By default, it lists the downloaded mails of the mailing list
that sent within last three days.  Users can let the command to do dowloading
of the mails together via `--fetch` option.  The sent time range of the mails
to list can be adjusted using `--since` and `--until` options.

In addition to the sent dates range, users can filter mails on the list by
author of the mail, keywords on subject or body, whether those are newly
started threads, via `--author`, `--subject_contains`, `--contains`, and
`--new` options, respectively.

The list shows all mails grouped by threads and sort the threads by sent date
of the latest mail of each thread.  Mails in each thread are sorted in the
reply order.  Users can show only first mail of each thread using `--collapse`
option.  It could be useful for mailing lists that people send huge amount of
mails every day.  Threads sorting key can also be customized using
`--sort_threads_by` option.  `--descend` option makes the sorting be done in
descendent order.  `--hot` option is a short cut for sorting threads by number
of comments in descendent way.

The sub-command support not only mailing lists on the manifest file, but also
mbox files.  You can pass the path to the mbox file instead of the mailing list
name.

Below example lists mails that sent to [DAMON](https://damonitor.github.io/)
mailing list from 2024-01-10 to 2024-01-20.

```
$ hkml list damon --fetch --since 2024-01-10 --until 2024-01-20
# 22 mails, 8 threads, 1 new threads
# 21 patches, 1 series
[0000] Re: [PATCH 5.15 00/59] 5.15.147-rc1 review (SeongJae Park, 01/13 10:42)
[0001] Re: [PATCH 6.1 0/4] 6.1.73-rc1 review (SeongJae Park, 01/13 10:43)
[0002] Re: [PATCH 6.6 0/1] 6.6.12-rc1 review (SeongJae Park, 01/13 10:44)
[0003] Re: DAMON Beer/Coffee/Tea chat series (SeongJae Park, 01/16 10:09)
[0004] [RFC PATCH 0/4] DAMON based 2-tier memory management for CXL memory (Honggyu Kim, 01/14
       20:52)
[0005]     [RFC PATCH 1/4] mm/vmscan: refactor reclaim_pages with reclaim_or_migrate_folios
           (Honggyu Kim, 01/14 20:52)
[0006]         re: (SeongJae Park, 01/16 12:32)
[0007]     [RFC PATCH 2/4] mm/damon: introduce DAMOS_DEMOTE action for demotion (Honggyu Kim,
           01/14 20:52)
[0008]         re: (SeongJae Park, 01/16 12:32)
[0009]     [RFC PATCH 3/4] mm/memory-tiers: add next_promotion_node to find promotion target
           (Honggyu Kim, 01/14 20:52)
[0010]         re: (SeongJae Park, 01/16 12:32)
[0011]     [RFC PATCH 4/4] mm/damon: introduce DAMOS_PROMOTE action for promotion (Honggyu
           Kim, 01/14 20:52)
[0012]         re: (SeongJae Park, 01/16 12:32)
[0013]     re: (SeongJae Park, 01/16 12:31)
[0014]         re: (Honggyu Kim, 01/17 03:49)
[0015]             re: (SeongJae Park, 01/17 13:11)
[0016]                 re: (SeongJae Park, 01/17 13:24)
[0017]                 re: (Hyeongtak Ji, 01/18 02:40)
[0018]                     re: (SeongJae Park, 01/18 09:17)
[0019] Re: [PATCH 6.1 000/100] 6.1.74-rc1 review (SeongJae Park, 01/18 10:35)
[0020] Re: [PATCH 6.6 000/150] 6.6.13-rc1 review (SeongJae Park, 01/18 10:36)
[0021] Re: [PATCH 6.7 00/28] 6.7.1-rc1 review (SeongJae Park, 01/18 12:17)
```

The output maybe intuitive to understand.  The first column of the each mail is
called index or identifier of the mail, and be used by other sub-commands that
will be described below.

Listing only Thread of Given Mail
=================================

On huge mailing list, reading all `hkml list` output takes time.  Users can
list mails of only specific threads containing specific mail using `thread`
sub-command.  The mail of the thread can be specified by passing the mail
identifier of the mail to the sub-command.  The mail identifier should be that
of previously generated list.  In other words, `thread` sub-command cannot be
used before `list` sub-command is executed at least once.

For example, below command show the thread for mail identifier 13 of the above
`hkml list` example.

```
$ ./hkml thread 13
[0004] [RFC PATCH 0/4] DAMON based 2-tier memory management for CXL memory (Honggyu Kim, 01/14
       20:52)
[0005]     [RFC PATCH 1/4] mm/vmscan: refactor reclaim_pages with reclaim_or_migrate_folios
           (Honggyu Kim, 01/14 20:52)
[0006]         re: (SeongJae Park, 01/16 12:32)
[0007]     [RFC PATCH 2/4] mm/damon: introduce DAMOS_DEMOTE action for demotion (Honggyu Kim,
           01/14 20:52)
[0008]         re: (SeongJae Park, 01/16 12:32)
[0009]     [RFC PATCH 3/4] mm/memory-tiers: add next_promotion_node to find promotion target
           (Honggyu Kim, 01/14 20:52)
[0010]         re: (SeongJae Park, 01/16 12:32)
[0011]     [RFC PATCH 4/4] mm/damon: introduce DAMOS_PROMOTE action for promotion (Honggyu
           Kim, 01/14 20:52)
[0012]         re: (SeongJae Park, 01/16 12:32)
[0013]     re: (SeongJae Park, 01/16 12:31)
[0014]         re: (Honggyu Kim, 01/17 03:49)
[0015]             re: (SeongJae Park, 01/17 13:11)
[0016]                 re: (SeongJae Park, 01/17 13:24)
[0017]                 re: (Hyeongtak Ji, 01/18 02:40)
[0018]                     re: (SeongJae Park, 01/18 09:17)
```

Reading Mails
=============

Users can open the content of the mail using `open` subcommand.  It receives
the identifier of the mail to read.  The identifier should be that of the last
generated `list` output.

For example, below command shows the 18-th mail of the above list.

```
Local-Date: 2024-01-18 09:17:56-08:00
Date: Thu, 18 Jan 2024 09:17:56 -0800
Subject: Re: [RFC PATCH 0/4] DAMON based 2-tier memory management for CXL memory
Message-Id: <20240118171756.80356-1-sj@kernel.org>
From: SeongJae Park <sj@kernel.org>
To: Hyeongtak Ji <hyeongtak.ji@sk.com>
CC: sj@kernel.org, akpm@linux-foundation.org, apopple@nvidia.com, baolin.wang@linux.alibaba.com, damon@lists.linux.dev, dave.jiang@intel.com, honggyu.kim@sk.com, kernel_team@skhynix.com, linmiaohe@huawei.com, linux-kernel@vger.kernel.org, linux-mm@kvack.org, linux-trace-kernel@vger.kernel.org, lizhijian@cn.fujitsu.com, mathieu.desnoyers@efficios.com, mhiramat@kernel.org, rakie.kim@sk.com, rostedt@goodmis.org, surenb@google.com, yangx.jy@fujitsu.com, ying.huang@intel.com, ziy@nvidia.com

On Thu, 18 Jan 2024 19:40:16 +0900 Hyeongtak Ji <hyeongtak.ji@sk.com> wrote:

> Hi SeongJae,
>
> On Wed, 17 Jan 2024 SeongJae Park <sj@kernel.org> wrote:
>
> [...]
> >> Let's say there are 3 nodes in the system and the first node0 and node1
> >> are the first tier, and node2 is the second tier.
> >>
> >>   $ cat /sys/devices/virtual/memory_tiering/memory_tier4/nodelist
> >>   0-1
> >>
> >>   $ cat /sys/devices/virtual/memory_tiering/memory_tier22/nodelist
> >>   2
[...]
```

Replying
========

Users can reply to specific mail on the last generated list, using `reply`
sub-command.  Similar to `thread` and `open`, it receives the identifier of the
mail to reply for, on the last generated list.

The command formats reply mail for the given mail and open VIM for the user's
interactive writing of the content.  Once the user finishes writing it and
close the editor, the command will show the content of the written reply mail
and ask it is ok to send the mail.  If the user answers the mail is correct and
ok to send, `reply` sub-command will send it.  If the user answers to not send
the mail, `reply` sub-command will further ask if the user want to delete the
draft or save it for further edit.

For example,

```
$ hkml reply 3
[...] # hkml reply open VIM.  Below is an example output after closing VIM.

Will send above mail.  Okay? [y/N] n
Leave the draft message? [Y/n] y
The draft message is at /tmp/hkml_reply_py9o_yec
```

Note that `hkml` send mail using `git send-email`.  Hence `git send-email`
should be configured correctly on the user's system.

Writing New Mails
=================

Exporting Mails
===============
